<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>NiceToolKit</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>

<body>
    <div id="test-btn" v-on:click="test">
        <h1>{{ test_tips }}</h1>
    </div>
    <div id="devices-selector">
        <div v-on:click="refresh">refresh device list</div>
        <select v-model="selectedDevice"  @change="onDeviceChanged">
            <option v-for="device in devices" v-bind:value="device.id">{{device.name}}</option>
        </select>
        <span>Selected: {{ selectedDevice }}</span>
    </div>

    <div id="drag-file">
        <div class="dropbox" >
            <input type="file" multiple="multiple" @change="onFileSelected($event)" class="input-file">
        </div>
    </div>

    <div id="shortbut-box">
        <p v-on:click="openSettings">open settings</p>
        <p v-on:click="takeScreenshot">screenshot</p>
        <p v-on:click="inspectWebview">inspect</p>
    </div>

</body>
<style>
    #drag-file {
        background-color: blue;
        color: white;
        text-align: center;
        width: 300px;
        height: 300px;
    }
</style>

<script>
    let test = new Vue({
        el: '#test-btn',
        data: {
            test_tips: 'TEST BUTTON',
        },
        methods:{
            test: test_fn
        } 
    })

    let app = new Vue({
        el: '#devices-selector',
        data: {
            message: 'Hello Vue!',
            selectedDevice: "",
            devices: []
        },
        methods:{
            refresh: refresh_devices,
            onDeviceChanged:function(device) {
                console.log(this.selectedDevice);
            }
        } 
    })

    let shortcutBox = new Vue({
        el: '#shortbut-box',
        data: {
            test_tips: 'TEST BUTTON',
        },
        methods:{
            openSettings: function () {
                let shell = getAdbCmd(app.selectedDevice,"shell am start com.android.settings/.DevelopmentSettings");
                runCmd(shell).catch(function(error) {
                    console.log(error);
                });
            },
            takeScreenshot:function(){
                const electronApp = require('electron').remote.app;
                let runningPath = electronApp.getAppPath();
                console.log(runningPath);
                let pcStoragePath = "C:\\Users\\realhe.TENCENT\\Desktop\\screen.png"
                let shellScreen = getAdbCmd(app.selectedDevice,"shell screencap -p /sdcard/test.png");
                let shellPull = getAdbCmd(app.selectedDevice,"pull /sdcard/test.png " + pcStoragePath);
                runCmdArray([shellScreen,shellPull]).catch(function(error) {
                    console.log(error);
                });
                
            },
            inspectWebview:function(){
                window.open('chrome://inspect/#devices');
            }
        } 
    })

    let fileDrag = new Vue({
        el: '#drag-file',
        methods:{
            onFileSelected:function(event) {
                console.log(event);       
                for (let f of event.target.files) {
                    console.log('File(s) you dragged here: ', f.path)
        
                }
            }
        }
    })

    function getAdbCmd(deviceId,cmd){
        if(deviceId != ""){
            return "adb -s " + deviceId + " " + cmd;
        }else{
            return "adb " +  cmd;
        }
       
    }


    function runCmd(cmd) {
        return new Promise((resolve, reject) => {
            let exec = require('child_process').exec
            exec(cmd, function (err, stdout, stderr) {
                if(err){
                    reject(stderr);
                }else{
                    resolve(stdout);
                }
            });
        });
    }

     function runCmdArray(cmds) {
        return new Promise((resolve, reject) => {
            console.log("runCmdArray");
            
            let exec = require('child_process').exec
            function _runCmds(_cmds){
                console.log(_cmds);
                if(_cmds.length <= 0){
                    resolve("Execute all cmd finished.");
                    return;
                }
                let cmd = _cmds.shift()
                console.log("exec");
                console.log(cmd);
                exec(cmd, function (err, stdout, stderr) {
                    if(err){
                        reject(stderr);
                    }else{
                        console.log(stdout);
                        _runCmds(_cmds);
                    }
                });
            }
            _runCmds(cmds);
            
        });
    }

    function test_fn() {
        console.log(app.selectedDevice);
        
    }

    async function refresh_devices() {
        let res = await runCmd("adb devices");
        console.log(res);
        let lines = res.split(/[\r\n]+/g);
        let devices = [];
        let deviceIds = [];
        lines.forEach(line => {
            let deviceId = line.split(/[\s,;\t\n]+/)[0];
            if( deviceId  == "" || deviceId == "List" ){
                return;
            }
            deviceIds.push(deviceId);
        });
        
        app.selectedDevice = "正在刷新"
        app.devices = []

        //新增
        deviceIds.forEach(async function(deviceId){
            let deviceMsg = await runCmd("adb -s " + deviceId + ' shell  "cat /system/build.prop | grep "product""');
            let deviceName = (deviceMsg.split(/[\r\n]+/g)[0]).split("=")[1];
            app.devices.push({ id : deviceId , name :deviceName})
        }); 
    }


    
</script>

</html>